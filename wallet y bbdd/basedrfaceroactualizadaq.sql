-------------------------------------------------------
-- 1. LIMPIEZA TOTAL (Borrar todo lo viejo)
-------------------------------------------------------
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE APPOINTMENT CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE RECIPE CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE PACIENTE CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE CONTACTO CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE ADMIN_USER CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE SUSCRIPCION CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE PLAN CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE PREVISION CASCADE CONSTRAINTS PURGE';
    EXECUTE IMMEDIATE 'DROP TABLE CLINICA CASCADE CONSTRAINTS PURGE';

EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-------------------------------------------------------
-- 2. CREACIÓN DE TABLAS REALES (Usadas por Java)
-------------------------------------------------------

-- TABLA 1: CLINICA (Requerida para Pacientes)
CREATE TABLE CLINICA (
    CLINICA_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMBRE_CLINICA  VARCHAR2(100),
    RUT_CLINICA     VARCHAR2(20) UNIQUE
);

-- TABLA 2: ADMIN_USER (Login)
CREATE TABLE ADMIN_USER (
    ID       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    ROLE     VARCHAR2(20)
);

-- TABLA 3: PACIENTE (Módulo Pacientes)
CREATE TABLE PACIENTE (
    PACIENTE_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CLINICA_ID         NUMBER REFERENCES CLINICA(CLINICA_ID),
    NOMBRE_PACIENTE    VARCHAR2(100),
    APELLIDO_PACIENTE  VARCHAR2(100),
    RUT_PACIENTE       VARCHAR2(20),
    TELEFONO           VARCHAR2(20),
    DIRECCION_PACIENTE VARCHAR2(200), -- Usado para Diagnóstico/Info Extra
    FECHA_NACIMIENTO   DATE,
    GENERO             VARCHAR2(20),
    ESTADO             VARCHAR2(20) DEFAULT 'Activo'
);

-- TABLA 4: APPOINTMENT (Agenda Médica)
-- Nota: Java busca "APPOINTMENT", no "CITAS"
CREATE TABLE APPOINTMENT (
    ID               NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    APPOINTMENT_DATE VARCHAR2(20), -- Java lo maneja como String
    APPOINTMENT_TIME VARCHAR2(20),
    PATIENT_NAME     VARCHAR2(100),
    RUT              VARCHAR2(20),
    REASON           VARCHAR2(255),
    MEDIC_NAME       VARCHAR2(100),
    LOCATION         VARCHAR2(100),
    STATUS           VARCHAR2(50)
);

-- TABLA 5: RECIPE (Recetas Médicas)
-- Nota: Java busca "RECIPE", no "RECETAS_MEDICAS"
CREATE TABLE RECIPE (
    ID                  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PATIENT_NAME        VARCHAR2(100),
    RECIPE_DATE         VARCHAR2(20),
    DIAGNOSIS           VARCHAR2(255),
    MEDICAMENT          VARCHAR2(100),
    QUANTITY            VARCHAR2(50),
    DURATION            VARCHAR2(50),
    PRESCRIPTION_DETAIL VARCHAR2(500)
);

-- TABLA 6: CONTACTO (Formulario Web)
CREATE TABLE CONTACTO (
    ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME         VARCHAR2(100),
    EMAIL        VARCHAR2(100),
    SUBJECT      VARCHAR2(255),
    MESSAGE_BODY VARCHAR2(1000) -- Mapeado a 'message' en Java
);

-------------------------------------------------------
-- 3. POBLADO DE DATOS ESENCIALES
-------------------------------------------------------

-- 1. CLÍNICA POR DEFECTO (Vital para que funcione "Guardar Paciente")
INSERT INTO CLINICA (CLINICA_ID, NOMBRE_CLINICA, RUT_CLINICA) 
VALUES (1, 'Clínica Dr. Fachero Central', '77.123.456-7');

-- 2. USUARIOS DE ACCESO (Si Java no los crea, aquí están de respaldo)
-- Pass: password123 (Encriptada con BCrypt)
INSERT INTO ADMIN_USER (USERNAME, PASSWORD, ROLE) 
VALUES ('admin@drfachero.cl', '$2a$10$X/hXj.yvJ./P/..exampleHash..', 'ROLE_ADMIN');

INSERT INTO ADMIN_USER (USERNAME, PASSWORD, ROLE) 
VALUES ('user@drfachero.cl', '$2a$10$X/hXj.yvJ./P/..exampleHash..', 'ROLE_USER');

-- 3. DATOS DE PRUEBA (Para ver algo en el Dashboard)
INSERT INTO PACIENTE (CLINICA_ID, NOMBRE_PACIENTE, APELLIDO_PACIENTE, RUT_PACIENTE, TELEFONO, DIRECCION_PACIENTE, ESTADO)
VALUES (1, 'Juan', 'Pérez', '12.345.678-9', '987654321', 'Hipertensión controlada', 'Activo');

INSERT INTO APPOINTMENT (PATIENT_NAME, RUT, APPOINTMENT_DATE, APPOINTMENT_TIME, REASON, STATUS)
VALUES ('JUAN PÉREZ', '12.345.678-9', '2025-10-30', '10:00', 'Control General', 'Confirmada');

COMMIT;